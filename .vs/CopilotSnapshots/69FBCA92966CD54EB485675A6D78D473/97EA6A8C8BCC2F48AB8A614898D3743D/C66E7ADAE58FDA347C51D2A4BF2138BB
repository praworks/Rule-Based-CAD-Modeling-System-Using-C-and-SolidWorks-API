using System;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Runtime.Serialization;
using System.Runtime.Serialization.Json;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using SolidWorks.Interop.swconst;
using AICAD.Services;
using Newtonsoft.Json.Linq;

namespace AICAD.UI
{
    public partial class TextToCADTaskpane : UserControl
    {
        private readonly ISldWorks _swApp;
        private bool _isModified = false;
        private GeminiClient _client;
        private FileDbLogger _fileLogger;
        private MongoLogger _mongoLogger;
        private IGoodFeedbackStore _goodStore;
        private StatusWindow _statusWindow;
        private TimeSpan _lastLlm = TimeSpan.Zero;
        private TimeSpan _lastTotal = TimeSpan.Zero;
        private string _lastError;
        private string _lastPrompt;
        private string _lastReply;
        private string _lastModel;
        private string _lastDbStatus;
        private bool? _lastDbLogged;
        private string _lastRunId;
        private IStepStore _stepStore;
        private TextBox _txtFeedback;
        private Label _lblLlmStatus;
        private Label _lblDbStatus;
        private Label _lblSwStatus;
        private Label _lblTimes;

        public TextToCADTaskpane(ISldWorks swApp)
        {
            InitializeComponent();
            
            _swApp = swApp;

            // Set initial version
            var ver = GetAddinVersion();
            lblVersion.Text = ver;

            // Wire up event handlers
            shapePreset.SelectedIndexChanged += ShapePreset_SelectedIndexChanged;
            prompt.TextChanged += Prompt_TextChanged;
            build.Click += async (s, e) => await BuildFromPromptAsync();
            btnHistory.Click += BtnHistory_Click;
            btnStatus.Click += BtnStatus_Click;
            btnSettings.Click += BtnSettings_Click;
            btnThumbUp.Click += async (s, e) => await SubmitFeedbackAsync(true);
            btnThumbDown.Click += async (s, e) => await SubmitFeedbackAsync(false);

            TryApplyThumbIcons();

            try
            {
                var swEventPtr = _swApp as SldWorks;
                if (swEventPtr != null)
                {
                    swEventPtr.ActiveModelDocChangeNotify += new DSldWorksEvents_ActiveModelDocChangeNotifyEventHandler(OnActiveModelDocChanged);
                    swEventPtr.FileOpenPostNotify += new DSldWorksEvents_FileOpenPostNotifyEventHandler(OnFileOpenPostNotify);
                    swEventPtr.FileNewNotify2 += new DSldWorksEvents_FileNewNotify2EventHandler(OnFileNewNotify2);
                    swEventPtr.DocumentLoadNotify2 += new DSldWorksEvents_DocumentLoadNotify2EventHandler(OnDocumentLoadNotify2);
                }
            }
            catch { }

            SetLlmStatus("Idle", Color.DimGray);
            SetDbStatus("Unknown", Color.DimGray);
            SetSwStatus("Idle", Color.DimGray);
            SetTimes(null, null);
            SetLastError(null);
            try { Services.AddinStatusLogger.OnLog += (line) => { try { AppendStatusLine(line); } catch { } }; Services.AddinStatusLogger.Log("Init", "Taskpane subscribed to AddinStatusLogger"); } catch { }
            try { InitDbAndStores(); } catch (Exception ex) { AppendDetailedStatus("DB:init", "call exception", ex); }
        }

        private void ShapePreset_SelectedIndexChanged(object sender, EventArgs e)
        {
            var idx = shapePreset.SelectedIndex;
            switch (idx)
            {
                case 1: SetPromptText("Create a rectangular box 100 mm length, 50 mm width, 25 mm height"); break;
                case 2: SetPromptText("Create a cylinder 40 mm diameter and 80 mm height"); break;
                case 3: SetPromptText("Create a cube 10 mm"); break;
                default: SetPromptText(string.Empty); break;
            }
        }

        private void Prompt_TextChanged(object sender, EventArgs e)
        {
            try { SetModified(true); } catch { }
        }

        private string GetPromptText() => prompt.Text;

        private void SetPromptText(string text) => prompt.Text = text ?? string.Empty;

        private void BtnHistory_Click(object sender, EventArgs e)
        {
            try
            {
                if (_stepStore == null)
                {
                    MessageBox.Show(this, "No step store available", "History", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    return;
                }
                using (var dlg = new HistoryBrowser(_stepStore)) dlg.ShowDialog(this);
            }
            catch (Exception ex) { MessageBox.Show(this, ex.Message, "History", MessageBoxButtons.OK, MessageBoxIcon.Error); }
        }

        private void BtnStatus_Click(object sender, EventArgs e)
        {
            try
            {
                if (_statusWindow == null || _statusWindow.IsDisposed)
                {
                    _statusWindow = new StatusWindow();
                    _statusWindow.CopyErrorClicked += StatusWindow_CopyErrorClicked;
                    _statusWindow.CopyRunClicked += StatusWindow_CopyRunClicked;
                }
                _statusWindow.Show();
                _statusWindow.BringToFront();
            }
            catch (Exception ex) { AppendDetailedStatus("UI", "Status window error", ex); }
        }

        private void BtnSettings_Click(object sender, EventArgs e)
        {
            try
            {
                using (var dlg = new global::AICAD.UI.SettingsDialog())
                {
                    dlg.ShowDialog(this);
                }
            }
            catch (Exception ex) { AppendDetailedStatus("UI", "Settings dialog error", ex); }
        }

        // Initialize DB/logging and related stores at startup and append status lines
        private void InitDbAndStores()
        {
            try
            {
                var baseDir = @"D:\SolidWorks API\7. SolidWorks Taskpane Text To CAD"; // workspace folder
                _fileLogger = new FileDbLogger(baseDir);

                var mongoUri = System.Environment.GetEnvironmentVariable("MONGODB_URI")
                               ?? System.Environment.GetEnvironmentVariable("MONGO_LOG_CONN")
                               ?? string.Empty;
                var mongoDb = System.Environment.GetEnvironmentVariable("MONGODB_DB") ?? "TaskPaneAddin";
                var mongoCol = System.Environment.GetEnvironmentVariable("MONGODB_COLLECTION") ?? "SW";
                if (!string.IsNullOrWhiteSpace(mongoUri))
                {
                    try { _mongoLogger = new MongoLogger(mongoUri, mongoDb, mongoCol); } catch (Exception ex) { AppendDetailedStatus("DB:init", "MongoLogger ctor exception", ex); }
                }

                // Good feedback store
                if (!string.IsNullOrWhiteSpace(mongoUri))
                {
                    try { _goodStore = new MongoFeedbackStore(mongoUri, mongoDb, "good_feedback"); }
                    catch (Exception ex) { AppendDetailedStatus("DB:init", "MongoFeedbackStore ctor exception", ex); }
                }
                if (_goodStore == null)
                {
                    try { _goodStore = new SqliteFeedbackStore(baseDir); }
                    catch (Exception ex) { AppendStatusLine("[DB:init] SqliteFeedbackStore ctor exception: " + ex.Message); _goodStore = new FileGoodFeedbackStore(baseDir); }
                }

                // Step store
                if (!string.IsNullOrWhiteSpace(mongoUri))
                {
                    try { _stepStore = new MongoStepStore(mongoUri, mongoDb); }
                    catch (Exception ex) { AppendDetailedStatus("DB:init", "MongoStepStore ctor exception", ex); }
                }
                if (_stepStore == null)
                {
                    try { _stepStore = new SqliteStepStore(baseDir); }
                    catch (Exception ex) { AppendStatusLine("[DB:init] SqliteStepStore ctor exception: " + ex.Message); }
                }

                // Report status and details
                if (_mongoLogger != null && _mongoLogger.IsAvailable)
                {
                    SetDbStatus("MongoDB ready", Color.DarkGreen);
                    try
                    {
                        var info = Services.MongoLoggerExtensions.GetDebugInfo(_mongoLogger);
                        foreach (var line in info)
                        {
                            AppendStatusLine("[DB] " + line);
                        }
                    }
                    catch (Exception ex) { AppendDetailedStatus("DB", "debug info error", ex); }
                }
                else if (!string.IsNullOrWhiteSpace(_mongoLogger?.LastError))
                {
                    SetDbStatus("Mongo error: " + _mongoLogger.LastError, Color.Firebrick);
                    AppendStatusLine("[DB] Mongo error: " + _mongoLogger.LastError);
                }
                else
                {
                    SetDbStatus("File/SQLite ready", Color.DarkGreen);
                    AppendStatusLine("[DB] Logging using File/SQLite at: " + baseDir);
                }
            }
            catch (Exception ex)
            {
                SetDbStatus("Init error", Color.Firebrick);
                AppendDetailedStatus("DB:init", "exception", ex);
            }
        }

        private void AppendDbDebug()
        {
            try
            {
                if (_mongoLogger != null)
                {
                    foreach (var line in Services.MongoLoggerExtensions.GetDebugInfo(_mongoLogger))
                    {
                        AppendStatusLine("[DB:debug] " + line);
                    }
                    if (!string.IsNullOrWhiteSpace(_mongoLogger.LastError))
                    {
                        AppendStatusLine("[DB:debug] last_error: " + _mongoLogger.LastError);
                    }
                }
                else
                {
                    AppendStatusLine("[DB:debug] Mongo not configured; using File/SQLite");
                }
            }
            catch (Exception ex)
            {
                AppendDetailedStatus("DB:debug", "exception", ex);
            }
        }

        private Control BuildFeedbackPanel()
        {
            var gb = new GroupBox { Text = "Feedback", Dock = DockStyle.Fill };
            var tl = new TableLayoutPanel { Dock = DockStyle.Fill, ColumnCount = 3, RowCount = 3, Padding = new Padding(6) };
            tl.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 80));
            tl.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100));
            tl.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 100));
            tl.RowStyles.Add(new RowStyle(SizeType.Absolute, 28));
            tl.RowStyles.Add(new RowStyle(SizeType.Percent, 100));
            // Spacer row to keep empty space below the comment box
            tl.RowStyles.Add(new RowStyle(SizeType.Absolute, 10));

            _txtFeedback = new TextBox { Dock = DockStyle.Fill };

            tl.Controls.Add(btnThumbUp, 0, 0);
            tl.Controls.Add(btnThumbDown, 2, 0);
            tl.SetColumnSpan(_txtFeedback, 3);
            tl.Controls.Add(_txtFeedback, 0, 1);
            // Add an empty spacer row after the comment input
            var spacer = new Panel { Dock = DockStyle.Fill }; // height controlled by RowStyle above
            tl.SetColumnSpan(spacer, 3);
            tl.Controls.Add(spacer, 0, 2);
            gb.Controls.Add(tl);
            return gb;
        }

        private void SetRealTimeStatus(string text, Color color)
        {
            if (lblRealTimeStatus != null)
            {
                lblRealTimeStatus.Text = text ?? string.Empty;
                lblRealTimeStatus.ForeColor = color;
            }
            AppendStatusLine($"[Status] {text}");
        }

        private void SetLlmStatus(string text, Color color)
        {
            if (_lblLlmStatus == null)
            {
                _lblLlmStatus = new Label { AutoSize = true, Dock = DockStyle.Left, Padding = new Padding(6, 4, 6, 4) };
            }
            _lblLlmStatus.Text = text ?? string.Empty;
            _lblLlmStatus.ForeColor = color;
            AppendStatusLine($"[LLM] {text}");
        }

        private void SetDbStatus(string text, Color color)
        {
            if (_lblDbStatus == null)
            {
                _lblDbStatus = new Label { AutoSize = true, Dock = DockStyle.Left, Padding = new Padding(6, 4, 6, 4) };
            }
            _lblDbStatus.Text = text ?? string.Empty;
            _lblDbStatus.ForeColor = color;
            _lastDbStatus = text;
            AppendStatusLine($"[DB] {text}");
        }

        private void SetSwStatus(string text, Color color)
        {
            if (_lblSwStatus == null)
            {
                _lblSwStatus = new Label { AutoSize = true, Dock = DockStyle.Left, Padding = new Padding(6, 4, 6, 4) };
            }
            _lblSwStatus.Text = text ?? string.Empty;
            _lblSwStatus.ForeColor = color;
            AppendStatusLine($"[SW] {text}");
        }

        private void SetTimes(TimeSpan? llm, TimeSpan? total)
        {
            if (_lblTimes == null)
            {
                _lblTimes = new Label { AutoSize = true, Dock = DockStyle.Left, Padding = new Padding(6, 4, 6, 4) };
            }
            if (llm.HasValue || total.HasValue)
            {
                var parts = new System.Collections.Generic.List<string>();
                if (llm.HasValue) parts.Add($"LLM {llm.Value.TotalMilliseconds:F0} ms");
                if (total.HasValue) parts.Add($"Total {total.Value.TotalMilliseconds:F0} ms");
                _lblTimes.Text = string.Join(", ", parts);
                AppendStatusLine($"[Timing] {_lblTimes.Text}");
            }
            else
            {
                _lblTimes.Text = "—";
            }
        }

        private void SetLastError(string err)
        {
            _lastError = err;
            
                // Update status window if it's open
                if (_statusWindow != null && !_statusWindow.IsDisposed)
                {
                    _statusWindow.ErrorTextBox.Text = string.IsNullOrWhiteSpace(err) ? "—" : err;
                    _statusWindow.ErrorTextBox.ForeColor = string.IsNullOrWhiteSpace(err) ? Color.DimGray : Color.Firebrick;
                }
            
            if (!string.IsNullOrWhiteSpace(err)) AppendStatusLine($"[Error] {err}");
        }

        private string BuildErrorCopyText()
        {
            if (string.IsNullOrWhiteSpace(_lastError)) return null;
            var sb = new StringBuilder();
            sb.AppendLine($"Time: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine($"Error: {_lastError}");
            if (_lastLlm != TimeSpan.Zero || _lastTotal != TimeSpan.Zero)
            {
                sb.AppendLine($"LLM ms: {_lastLlm.TotalMilliseconds:F0}");
                sb.AppendLine($"Total ms: {_lastTotal.TotalMilliseconds:F0}");
            }
            if (!string.IsNullOrWhiteSpace(_lastPrompt)) sb.AppendLine($"Prompt: {_lastPrompt}");
            if (!string.IsNullOrWhiteSpace(_lastReply)) sb.AppendLine($"Reply: {_lastReply}");
            return sb.ToString();
        }

        private string BuildRunCopyText()
        {
            var sb = new StringBuilder();
            sb.AppendLine($"Time: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            if (!string.IsNullOrWhiteSpace(_lastModel)) sb.AppendLine($"Model: {_lastModel}");
            if (!string.IsNullOrWhiteSpace(_lastPrompt)) sb.AppendLine($"Prompt: {_lastPrompt}");
            if (!string.IsNullOrWhiteSpace(_lastReply)) sb.AppendLine($"Reply: {_lastReply}");
            if (_lastLlm != TimeSpan.Zero || _lastTotal != TimeSpan.Zero)
            {
                sb.AppendLine($"LLM ms: {_lastLlm.TotalMilliseconds:F0}");
                sb.AppendLine($"Total ms: {_lastTotal.TotalMilliseconds:F0}");
            }
            if (!string.IsNullOrWhiteSpace(_lastDbStatus)) sb.AppendLine($"DB: {_lastDbStatus}");
            if (_lastDbLogged.HasValue) sb.AppendLine($"DbLogged: {_lastDbLogged.Value}");
            if (!string.IsNullOrWhiteSpace(_lastError)) sb.AppendLine($"Error: {_lastError}");
            return sb.ToString();
        }

        private GeminiClient GetClient()
        {
            if (_client == null)
            {
                // WARNING: Storing API keys directly in code is not secure.
                // This is for demonstration purposes only.
                var key = "AIzaSyBUzKATKs5ea0mTSmGziZDnDdjaDK1RpjE"; // <-- IMPORTANT: This key is now hardcoded.

                if (key == "REPLACE_WITH_YOUR_KEY_DO_NOT_COMMIT")
                {
                    AppendDetailedStatus("LLM", "API Key is not set. Please edit UI/TextToCADTaskpane.cs and replace the placeholder key.", null);
                    throw new InvalidOperationException("API Key is not set in the source code. Please edit UI/TextToCADTaskpane.cs.");
                }

                var preferredModel = System.Environment.GetEnvironmentVariable("GEMINI_MODEL", System.EnvironmentVariableTarget.User)
                                     ?? System.Environment.GetEnvironmentVariable("GEMINI_MODEL", System.EnvironmentVariableTarget.Process)
                                     ?? System.Environment.GetEnvironmentVariable("GEMINI_MODEL", System.EnvironmentVariableTarget.Machine)
                                     ?? "gemini-1.0-pro"; // Updated to a more current model
                _client = new GeminiClient(key, preferredModel);
                AppendStatusLine("[LLM] Gemini client constructed with hardcoded API key.");
                
                // Initialize logging and data stores
                var baseDir = @"D:\SolidWorks API\9. SolidWorks Taskpane Text To CAD"; // workspace folder
                _fileLogger = new FileDbLogger(baseDir);

                var mongoUri = System.Environment.GetEnvironmentVariable("MONGODB_URI") ?? string.Empty;
                var mongoDb = System.Environment.GetEnvironmentVariable("MONGODB_DB") ?? "TaskPaneAddin";
                
                if (!string.IsNullOrWhiteSpace(mongoUri))
                {
                    try
                    {
                        _mongoLogger = new MongoLogger(mongoUri, mongoDb, "SW");
                        _goodStore = new MongoFeedbackStore(mongoUri, mongoDb, "good_feedback");
                        _stepStore = new MongoStepStore(mongoUri, mongoDb);
                        AppendStatusLine("[DB] MongoDB stores initialized.");
                    }
                    catch (Exception ex) { AppendDetailedStatus("DB", "Mongo store initialization failed", ex); }
                }

                if (_goodStore == null)
                {
                    try { _goodStore = new SqliteFeedbackStore(baseDir); }
                    catch { _goodStore = new FileGoodFeedbackStore(baseDir); }
                }
                if (_stepStore == null)
                {
                    try { _stepStore = new SqliteStepStore(baseDir); }
                    catch { /* keep null if not available */ }
                }

                if (_mongoLogger != null && _mongoLogger.IsAvailable)
                {
                    SetDbStatus("MongoDB ready", Color.DarkGreen);
                }
                else
                {
                    SetDbStatus("File/SQLite ready", Color.DarkGreen);
                }
            }
            return _client;
        }

        private async Task BuildFromPromptAsync()
        {
            var text = (GetPromptText() ?? string.Empty).Trim();
            if (string.IsNullOrEmpty(text))
            {
                Log("Enter a prompt describing a simple box or cylinder in mm.");
                return;
            }

            var totalSw = System.Diagnostics.Stopwatch.StartNew();
            string reply = null;
            string errText = null;
            TimeSpan llmMs = TimeSpan.Zero;
            StepExecutionResult exec = null;
            try
            {
                build.Enabled = false;
                _lastPrompt = text;
                Log("> " + text);
                SetRealTimeStatus("Communicating with LLM…", Color.DarkOrange);
                SetLlmStatus("Sending…", Color.DarkOrange);
                SetLastError(null);
                SetTimes(null, null);

                // Ask Gemini to produce a corrective, executable plan of SOLIDWORKS steps (few-shot guided)
                var fewshot = new StringBuilder()
                    .Append("Examples:")
                    .Append("\nInput: Box 100x50x25 mm")
                    .Append("\nOutput:{\n  \"steps\":[\n    {\"op\":\"new_part\"},\n    {\"op\":\"select_plane\",\"name\":\"Front Plane\"},\n    {\"op\":\"sketch_begin\"},\n    {\"op\":\"rectangle_center\",\"cx\":0,\"cy\":0,\"w\":100,\"h\":50},\n    {\"op\":\"sketch_end\"},\n    {\"op\":\"extrude\",\"depth\":25,\"type\":\"boss\"}\n  ]\n}")
                    .Append("\nInput: Cylinder 40 dia x 80 mm")
                    .Append("\nOutput:{\n  \"steps\":[\n    {\"op\":\"new_part\"},\n    {\"op\":\"select_plane\",\"name\":\"Front Plane\"},\n    {\"op\":\"sketch_begin\"},\n    {\"op\":\"circle_center\",\"cx\":0,\"cy\":0,\"diameter\":40},\n    {\"op\":\"sketch_end\"},\n    {\"op\":\"extrude\",\"depth\":80}\n  ]\n}");

                // Add dynamic few-shots from SQLite good feedback
                if (_goodStore != null)
                {
                    var extras = _goodStore.GetRecentFewShots(2);
                    foreach (var s in extras)
                    {
                        fewshot.Append(s);
                    }
                }
                // Add retrieval from step store
                if (_stepStore != null)
                {
                    var more = _stepStore.GetRelevantFewShots(text, 3);
                    foreach (var s in more) fewshot.Append(s);
                }

                var sysPrompt =
                    "You are a CAD planning agent. Convert the user request into a step plan JSON for SOLIDWORKS. " +
                    "Supported ops: new_part; select_plane{name}; sketch_begin; rectangle_center{cx,cy,w,h}; circle_center{cx,cy,r|diameter}; sketch_end; extrude{depth,type?}. " +
                    "Units are millimeters; output ONLY raw JSON with a top-level 'steps' array. No markdown or extra text.\n" + fewshot + "\nNow generate plan for: ";
                var client = GetClient();
                _lastModel = client?.Model;
                SetRealTimeStatus("Applying few-shot examples…", Color.DarkOrange);
                var llmSw = System.Diagnostics.Stopwatch.StartNew();
                reply = await client.GenerateAsync(sysPrompt + fewshot.ToString() + "\nNow generate plan for: " + text + "\nJSON:");
                llmSw.Stop();
                llmMs = llmSw.Elapsed;
                _lastReply = reply;
                Log(reply);
                SetRealTimeStatus("Received response from LLM", Color.DarkGreen);
                SetLlmStatus("OK", Color.DarkGreen);

                // Try-corrective loop: up to 2 attempts; on failure, feed back error log to LLM to fix
                SetRealTimeStatus("Executing plan…", Color.DarkOrange);
                SetSwStatus("Working…", Color.DarkOrange);
                var attempt = 0;
                var maxAttempts = 2;
                string planJson = ExtractRawJson(reply);
                Newtonsoft.Json.Linq.JObject planDoc = null;
                for (; attempt < maxAttempts; attempt++)
                {
                    try
                    {
                        planDoc = Newtonsoft.Json.Linq.JObject.Parse(planJson);
                    }
                    catch (Exception ex)
                    {
                        errText = "plan-parse: " + ex.Message;
                        break;
                    }

                    exec = Services.StepExecutor.Execute(planDoc, _swApp);
                    if (exec.Success) break;

                    // Build corrective prompt with error log for next attempt
                    var errDoc = new JObject
                    {
                        ["last_plan"] = SafeJson(planJson),
                        ["errors"] = new JArray(exec.Log)
                    };
                    var corrective =
                        "Your previous plan failed in SOLIDWORKS. Fix the plan based on this error log and output only corrected JSON.\n" +
                        errDoc.ToString(Newtonsoft.Json.Formatting.None) +
                        "\nRemember: output only JSON with steps; use Front Plane and mm units.";
                    // If we created a model this attempt and failed, close it before retry
                    try
                    {
                        if (exec.CreatedNewPart && !exec.Success && _swApp != null && !string.IsNullOrWhiteSpace(exec.ModelTitle))
                        {
                            _swApp.CloseDoc(exec.ModelTitle);
                        }
                    }
                    catch { }

                    var llmFixSw = System.Diagnostics.Stopwatch.StartNew();
                    var fixedPlan = await client.GenerateAsync(corrective);
                    llmFixSw.Stop();
                    llmMs += llmFixSw.Elapsed;
                    planJson = ExtractRawJson(fixedPlan);
                }

                if (exec != null && exec.Success)
                {
                    Log("Model created.");
                    SetRealTimeStatus("Creating model…", Color.DarkOrange);
                    SetSwStatus("OK", Color.DarkGreen);
                    // Clear modified state after successful create/save
                    try { SetModified(false); } catch { }
                }
                else
                {
                    var swError = (exec != null && exec.Log.Count > 0 && exec.Log[exec.Log.Count - 1].ContainsKey("error"))
                        ? exec.Log[exec.Log.Count - 1].Value<string>("error")
                        : (errText ?? "Unknown error");
                    Log("SOLIDWORKS error: " + swError);
                    SetRealTimeStatus("Error: " + swError, Color.Firebrick);
                    SetSwStatus("Error", Color.Firebrick);
                    if (string.IsNullOrWhiteSpace(errText)) errText = swError;
                    SetLastError(swError);
                    // Close any newly created model on final failure to avoid leftover document
                    try
                    {
                        if (exec != null && exec.CreatedNewPart && _swApp != null && !string.IsNullOrWhiteSpace(exec.ModelTitle))
                        {
                            _swApp.CloseDoc(exec.ModelTitle);
                        }
                    }
                    catch { }
                }
                _lastLlm = llmMs;
                _lastTotal = totalSw.Elapsed;
                SetTimes(llmMs, totalSw.Elapsed);

                // Persist to step store (runs + steps)
                try
                {
                    _lastRunId = DateTime.UtcNow.ToString("yyyyMMddHHmmssfff");
                    if (_stepStore != null)
                    {
                        var ok = await _stepStore.SaveRunWithStepsAsync(
                            _lastRunId,
                            text,
                            _lastModel ?? "gemini",
                            ExtractRawJson(_lastReply),
                            exec,
                            llmMs,
                            totalSw.Elapsed,
                            errText);
                        if (!ok && !string.IsNullOrWhiteSpace(_stepStore.LastError))
                        {
                            SetDbStatus("StepStore error: " + _stepStore.LastError, Color.Firebrick);
                        }
                    }
                }
                catch { }
            }
            catch (Exception ex)
            {
                errText = ex.Message;
                Log("Error: " + ex.Message);
                SetRealTimeStatus("Error: " + ex.Message, Color.Firebrick);
                SetLlmStatus("Error", Color.Firebrick);
                SetSwStatus("Error", Color.Firebrick);
                SetLastError(ex.Message);
                _lastLlm = llmMs;
                _lastTotal = totalSw.Elapsed;
                SetTimes(llmMs, totalSw.Elapsed);
            }
            finally
            {
                totalSw.Stop();
                try
                {
                    SetRealTimeStatus("Saving feedback to database…", Color.DarkOrange);
                    SetDbStatus("Logging…", Color.DarkOrange);
                    bool logged = false;
                    // Try Mongo first
                    if (_mongoLogger != null && _mongoLogger.IsAvailable)
                    {
                        logged = await _mongoLogger.LogAsync(text, reply, _lastModel ?? "gemini", llmMs, totalSw.Elapsed, errText);
                        if (!logged && !string.IsNullOrWhiteSpace(_mongoLogger.LastError))
                        {
                            SetDbStatus("Mongo log error: " + _mongoLogger.LastError, Color.Firebrick);
                        }
                        else if (logged)
                        {
                            // Also insert detailed run doc into a secondary collection
                            try
                            {
                                var doc = new MongoDB.Bson.BsonDocument
                                {
                                    { "runId", _lastRunId ?? DateTime.UtcNow.ToString("yyyyMMddHHmmssfff") },
                                    { "timestamp", DateTime.UtcNow },
                                    { "prompt", text },
                                    { "model", _lastModel ?? "gemini" },
                                    { "plan", ExtractRawJson(_lastReply ?? "{}") },
                                    { "exec", MongoDB.Bson.Serialization.BsonSerializer.Deserialize<MongoDB.Bson.BsonArray>(ExecLogToJson(exec).ToString()) },
                                    { "success", exec?.Success ?? false },
                                    { "llmMs", (long)llmMs.TotalMilliseconds },
                                    { "totalMs", (long)totalSw.Elapsed.TotalMilliseconds },
                                    { "error", errText ?? string.Empty }
                                };
                                await _mongoLogger.InsertAsync("SW_Runs", doc);
                            }
                            catch { }
                        }
                    }

                    // Fallback to file logger if Mongo failed/unavailable
                    if (!logged && _fileLogger != null)
                    {
                        logged = await _fileLogger.LogAsync(text, reply, _lastModel ?? "gemini", llmMs, totalSw.Elapsed, errText);
                        if (string.IsNullOrEmpty(_lastRunId)) _lastRunId = DateTime.UtcNow.ToString("yyyyMMddHHmmssfff");
                        try
                        {
                            var doc = new JObject
                            {
                                ["runId"] = _lastRunId,
                                ["timestamp"] = DateTime.UtcNow,
                                ["prompt"] = text,
                                ["model"] = _lastModel ?? "gemini",
                                ["plan"] = SafeJson(ExtractRawJson(_lastReply)),
                                ["exec"] = ExecLogToJson(exec),
                                ["success"] = exec?.Success ?? false,
                                ["llmMs"] = (long)llmMs.TotalMilliseconds,
                                ["totalMs"] = (long)totalSw.Elapsed.TotalMilliseconds,
                                ["error"] = errText ?? string.Empty
                            };
                            await _fileLogger.InsertAsync("SW_Runs", doc);
                        }
                        catch { }
                    }

                    _lastDbLogged = logged;
                    SetDbStatus(logged ? "Logged" : "Log error", logged ? Color.DarkGreen : Color.Firebrick);
                    SetRealTimeStatus(logged ? "Completed" : "Error logging", logged ? Color.DarkGreen : Color.Firebrick);
                }
                catch
                {
                    SetDbStatus("Log error (exception)", Color.Firebrick);
                    SetRealTimeStatus("Error logging", Color.Firebrick);
                }
                build.Enabled = true;
            }
        }

        private void SetModified(bool modified)
        {
            _isModified = modified;
            if (lblModified != null)
            {
                lblModified.Visible = modified;
            }
        }

        private string GetAddinVersion()
        {
            try
            {
                var asm = typeof(TextToCADTaskpane).Assembly;
                var fileVer = System.Diagnostics.FileVersionInfo.GetVersionInfo(asm.Location)?.FileVersion;
                if (!string.IsNullOrWhiteSpace(fileVer)) return "v" + fileVer;
                var ver = asm.GetName().Version?.ToString();
                return string.IsNullOrWhiteSpace(ver) ? "v?" : "v" + ver;
            }
            catch { return "v?"; }
        }

        // SOLIDWORKS event handlers (simple int-return signatures expected by COM)
        private int OnFileSaved(int saveType, string fileName)
        {
            try
            {
                SetModified(false);
            }
            catch { }
            return 0;
        }

        private int OnActiveModelDocChanged()
        {
            try
            {
                SetModified(false);
            }
            catch { }
            return 0;
        }

        private int OnFileOpenPostNotify(string fileName)
        {
            try { SetModified(false); } catch { }
            return 0;
        }

        private int OnFileNewNotify2(object newDoc, int docType, string templateName)
        {
            try { SetModified(false); } catch { }
            return 0;
        }

        private int OnDocumentLoadNotify2(string docTitle, string docPath)
        {
            try { SetModified(false); } catch { }
            return 0;
        }

        private static JToken SafeJson(string json)
        {
            try { return JToken.Parse(json); } catch { return (json ?? string.Empty); }
        }

        private async Task SubmitFeedbackAsync(bool up)
        {
            try
            {
                if (_fileLogger == null && _mongoLogger == null)
                {
                    SetDbStatus("Feedback not saved (no logger)", Color.DarkOrange);
                    return;
                }
                var fb = new JObject
                {
                    ["runId"] = _lastRunId ?? string.Empty,
                    ["timestamp"] = DateTime.UtcNow,
                    ["thumb"] = up ? "up" : "down",
                    ["comment"] = _txtFeedback?.Text ?? string.Empty,
                    ["prompt"] = _lastPrompt ?? string.Empty,
                    ["model"] = _lastModel ?? string.Empty
                };
                bool ok = false;
                // Try Mongo first
                if (_mongoLogger != null && _mongoLogger.IsAvailable)
                {
                    try
                    {
                        var bdoc = MongoDB.Bson.Serialization.BsonSerializer.Deserialize<MongoDB.Bson.BsonDocument>(fb.ToString());
                        ok = await _mongoLogger.InsertAsync("Feedback", bdoc);
                    }
                    catch { ok = false; }
                }
                // Fallback to file
                if (!ok && _fileLogger != null)
                {
                    ok = await _fileLogger.InsertAsync("Feedback", fb);
                }
                if (up && _goodStore != null)
                {
                    // Also persist to SQLite as a positive example
                    // Try to capture the last plan from the last reply
                    string plan = ExtractRawJson(_lastReply ?? "{}");
                    var saved = await _goodStore.SaveGoodAsync(_lastRunId, _lastPrompt, _lastModel, plan, _txtFeedback?.Text);
                    if (!saved && !string.IsNullOrWhiteSpace(_goodStore.LastError))
                    {
                        SetDbStatus("GoodStore error: " + _goodStore.LastError, Color.Firebrick);
                    }
                }
                // Also mirror to step store
                if (_stepStore != null)
                {
                    var s2ok = await _stepStore.SaveFeedbackAsync(_lastRunId, up, _txtFeedback?.Text);
                    if (!s2ok && !string.IsNullOrWhiteSpace(_stepStore.LastError))
                    {
                        SetDbStatus("StepStore fb error: " + _stepStore.LastError, Color.Firebrick);
                    }
                }
                SetDbStatus(ok ? "Feedback saved" : "Feedback error", ok ? Color.DarkGreen : Color.Firebrick);
            }
            catch (Exception ex)
            {
                SetDbStatus("Feedback error: " + ex.Message, Color.Firebrick);
            }
        }

        private bool BuildModel(ShapeSpec spec, out string error)
        {
            error = null;
            if (_swApp == null) { error = "SOLIDWORKS app not available"; return false; }

            // New part
            var model = (IModelDoc2)_swApp.NewDocument("", (int)swDwgPaperSizes_e.swDwgPaperA4size, 0, 0);
            if (model == null)
            {
                // fallback using default part template setting
                model = (IModelDoc2)_swApp.NewPart();
            }
            if (model == null) { error = "Failed to create new part (check default template)"; return false; }

            int actErr = 0;
            _swApp.ActivateDoc3(model.GetTitle(), true, (int)swRebuildOptions_e.swRebuildAll, ref actErr);

            if (spec.Shape == "box")
            {
                if (!BuildBox(model, spec.LengthMm.Value, spec.WidthMm.Value, spec.HeightMm.Value, out error)) return false;
            }
            else if (spec.Shape == "cylinder")
            {
                if (!BuildCylinder(model, spec.DiameterMm.Value, spec.HeightMm.Value, out error)) return false;
            }
            return true;
        }

        private bool BuildBox(IModelDoc2 model, double length, double width, double height, out string error)
        {
            error = null;
            var sketchMgr = model.SketchManager;
            var featMgr = model.FeatureManager;

            // Front plane
            var sel = model.Extension.SelectByID2("Front Plane", "PLANE", 0, 0, 0, false, 0, null, 0);
            if (!sel) { error = "Could not select Front Plane"; return false; }
            sketchMgr.InsertSketch(true);

            // Center rectangle on origin sized to length x width (mm -> m conversion factor = 0.001)
            double L = length / 1000.0, W = width / 1000.0;
            var rect = sketchMgr.CreateCenterRectangle(0, 0, 0, L / 2.0, W / 2.0, 0);
            if (rect == null) { error = "Failed to create rectangle"; return false; }
            sketchMgr.InsertSketch(true);

            // Extrude by height
            double H = height / 1000.0;
            var feat = featMgr.FeatureExtrusion2(true,            // boss
                                      false,
                                      false,
                                      (int)swEndConditions_e.swEndCondBlind,
                                      (int)swEndConditions_e.swEndCondBlind,
                                      H,
                                      0,
                                      false,
                                      false,
                                      false,
                                      false,
                                      0,
                                      0,
                                      false,
                                      false,
                                      false,
                                      false,
                                      true,
                                      false,
                                      false,
                                      (int)swStartConditions_e.swStartSketchPlane,
                                      0,
                                      false);
            if (feat == null) { error = "Extrude failed"; return false; }
            return true;
        }

        private bool BuildCylinder(IModelDoc2 model, double diameter, double height, out string error)
        {
            error = null;
            var sketchMgr = model.SketchManager;
            var featMgr = model.FeatureManager;

            // Front plane
            var sel = model.Extension.SelectByID2("Front Plane", "PLANE", 0, 0, 0, false, 0, null, 0);
            if (!sel) { error = "Could not select Front Plane"; return false; }
            sketchMgr.InsertSketch(true);

            // Circle at origin with diameter (mm)
            double R = (diameter / 1000.0) / 2.0;
            var circ = sketchMgr.CreateCircleByRadius(0, 0, 0, R);
            if (circ == null) { error = "Failed to create circle"; return false; }
            sketchMgr.InsertSketch(true);

            // Extrude by height (mm)
            double H = height / 1000.0;
            var feat = featMgr.FeatureExtrusion2(true,
                                      false,
                                      false,
                                      (int)swEndConditions_e.swEndCondBlind,
                                      (int)swEndConditions_e.swEndCondBlind,
                                      H,
                                      0,
                                      false,
                                      false,
                                      false,
                                      false,
                                      0,
                                      0,
                                      false,
                                      false,
                                      false,
                                      false,
                                      true,
                                      false,
                                      false,
                                      (int)swStartConditions_e.swStartSketchPlane,
                                      0,
                                      false);
            if (feat == null) { error = "Extrude failed"; return false; }
            return true;
        }

        private bool TryParseSpec(string json, out ShapeSpec spec, out string error)
        {
            spec = null;
            error = null;
            try
            {
                var raw = ExtractRawJson(json);
                var bytes = Encoding.UTF8.GetBytes(raw);
                using (var ms = new System.IO.MemoryStream(bytes))
                {
                    var ser = new DataContractJsonSerializer(typeof(ShapeSpec));
                    spec = (ShapeSpec)ser.ReadObject(ms);
                }

                if (spec == null || string.IsNullOrEmpty(spec.Shape)) { error = "missing shape"; return false; }
                spec.Shape = spec.Shape.ToLowerInvariant();
                if (spec.Shape == "box")
                {
                    if (!spec.LengthMm.HasValue || !spec.WidthMm.HasValue || !spec.HeightMm.HasValue)
                    { error = "box requires length,width,height"; return false; }
                }
                else if (spec.Shape == "cylinder")
                {
                    if (!spec.DiameterMm.HasValue || !spec.HeightMm.HasValue)
                    { error = "cylinder requires diameter,height"; return false; }
                }
                else
                {
                    error = "unsupported shape"; return false;
                }
                return true;
            }
            catch (Exception ex)
            {
                error = ex.Message;
                return false;
            }
        }

        private string ExtractRawJson(string text)
        {
            if (string.IsNullOrWhiteSpace(text)) return "{}";
            var t = text.Trim();

            // Strip markdown code fences if present
            if (t.StartsWith("```"))
            {
                var newline = t.IndexOf('\n');
                if (newline >= 0)
                {
                    t = t.Substring(newline + 1);
                    var fence = t.LastIndexOf("```", StringComparison.Ordinal);
                    if (fence >= 0) t = t.Substring(0, fence);
                    t = t.Trim();
                }
            }

            // Extract the first balanced JSON object if extra text remains
            int start = t.IndexOf('{');
            if (start >= 0)
            {
                int depth = 0;
                bool inString = false;
                for (int i = start; i < t.Length; i++)
                {
                    char c = t[i];
                    if (c == '"')
                    {
                        // naive toggle; sufficient for our simple JSON
                        inString = !inString;
                    }
                    if (!inString)
                    {
                        if (c == '{') depth++;
                        else if (c == '}')
                        {
                            depth--;
                            if (depth == 0)
                            {
                                return t.Substring(start, i - start + 1);
                            }
                        }
                    }
                }
                // unmatched braces; return best-effort
                return t.Substring(start).Trim();
            }

            return t;
        }

        private void Log(string text)
        {
            if (log.InvokeRequired)
            {
                log.Invoke(new Action(() => log.Text = text));
            }
            else
            {
                log.Text = text;
            }
        }

        private void TryApplyThumbIcons()
        {
            try
            {
                var baseDir = AppDomain.CurrentDomain.BaseDirectory;
                var upCandidates = new[]
                {
                    Path.Combine(baseDir, "Resources", "thumb_up.png"),
                    Path.Combine(baseDir, "Resources", "thumb-up.png"),
                    Path.Combine(baseDir, "thumb_up.png"),
                    Path.Combine(baseDir, "thumb-up.png")
                };
                var downCandidates = new[]
                {
                    Path.Combine(baseDir, "Resources", "thumb_down.png"),
                    Path.Combine(baseDir, "Resources", "thumb-down.png"),
                    Path.Combine(baseDir, "thumb_down.png"),
                    Path.Combine(baseDir, "thumb-down.png")
                };
                SetThumbIcon(btnThumbUp, upCandidates);
                SetThumbIcon(btnThumbDown, downCandidates);
            }
            catch { }
        }

        private static void SetThumbIcon(Button btn, string[] candidates)
        {
            // First, scan the Resources folder for wildcard matches like thumb*up*.png or thumb*down*.png
            try
            {
                var baseDir = AppDomain.CurrentDomain.BaseDirectory;
                var resDir = Path.Combine(baseDir, "Resources");
                if (Directory.Exists(resDir))
                {
                    string pattern = btn.Text.Contains("👍") ? "thumb*up*.png" : "thumb*down*.png";
                    var found = Directory.GetFiles(resDir, pattern, SearchOption.TopDirectoryOnly);
                    if (found != null && found.Length > 0)
                    {
                        candidates = found.Concat(candidates).ToArray();
                    }
                }
            }
            catch { }

            foreach (var p in candidates)
            {
                try
                {
                    if (File.Exists(p))
                    {
                        using (var img = Image.FromFile(p))
                        {
                            // Scale to fit nicely in a 28px tall button
                            var scaled = new Bitmap(img, new Size(20, 20));
                            btn.Image = scaled;
                        }
                        btn.Text = string.Empty;
                        btn.ImageAlign = ContentAlignment.MiddleCenter;
                        btn.FlatStyle = FlatStyle.Standard;
                        btn.Width = Math.Max(btn.Width, 40);
                        btn.Height = Math.Max(btn.Height, 28);
                        return;
                    }
                }
                catch { }
            }
        }

        private void AppendStatusLine(string line)
        {
            try
            {
                    // Write to status window if it's open
                    if (_statusWindow != null && !_statusWindow.IsDisposed)
                    {
                        var ts = DateTime.Now.ToString("HH:mm:ss");
                        _statusWindow.StatusConsole.SelectionStart = _statusWindow.StatusConsole.TextLength;
                        _statusWindow.StatusConsole.SelectionColor = Color.Gainsboro;
                        _statusWindow.StatusConsole.AppendText($"{ts} {line}\n");
                        _statusWindow.StatusConsole.SelectionStart = _statusWindow.StatusConsole.TextLength;
                        _statusWindow.StatusConsole.ScrollToCaret();
                        try { MirrorStatusToTempFile($"{ts} {line}"); } catch { }
                        return;
                    }

                    // If no window, still mirror to temp log for diagnostics
                    try { MirrorStatusToTempFile(DateTime.Now.ToString("HH:mm:ss") + " " + line); } catch { }
                }
                catch { }
            }

            private void StatusWindow_CopyErrorClicked(object sender, EventArgs e)
            {
                try
                {
                    var text = BuildErrorCopyText();
                    if (!string.IsNullOrEmpty(text))
                    {
                        Clipboard.SetText(text);
                        AppendStatusLine("[UI] Error copied to clipboard");
                    }
                }
                catch (Exception ex) { AppendDetailedStatus("UI", "Copy error failed", ex); }
            }

            private void StatusWindow_CopyRunClicked(object sender, EventArgs e)
            {
                try
                {
                    var text = BuildRunCopyText();
                    if (!string.IsNullOrEmpty(text))
                    {
                        Clipboard.SetText(text);
                        AppendStatusLine("[UI] Run copied to clipboard");
                    }
                }
                catch (Exception ex) { AppendDetailedStatus("UI", "Copy run failed", ex); }
            }

        // Mirror status console to a temp file for persistent debugging traces.
        private void MirrorStatusToTempFile(string line)
        {
            try
            {
                var path = System.IO.Path.Combine(System.IO.Path.GetTempPath(), "TextToCAD_Status.log");
                System.IO.File.AppendAllText(path, DateTime.Now.ToString("o") + " " + line + System.Environment.NewLine);
            }
            catch { }
        }

        // Append a detailed status entry including exception stack traces when available.
        // This is safe to call even when loggers are not yet initialized.
        private void AppendDetailedStatus(string category, string message, Exception ex)
        {
            try
            {
                var header = string.IsNullOrWhiteSpace(message) ? $"[{category}]" : $"[{category}] {message}";
                AppendStatusLine(header);
                if (ex != null)
                {
                    // Include full exception.ToString() which contains stack trace and inner exceptions
                    var full = ex.ToString();
                    var lines = full.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                    foreach (var ln in lines)
                    {
                        AppendStatusLine("  " + ln.Trim());
                    }
                }
            }
            catch { }
        }

        private JArray ExecLogToJson(StepExecutionResult exec)
        {
            var arr = new JArray();
            if (exec?.Log != null)
            {
                foreach (var entry in exec.Log)
                {
                    arr.Add(entry);
                }
            }
            return arr;
        }
    }

    [DataContract]
    internal class ShapeSpec
    {
        [DataMember(Name = "shape")]
        public string Shape { get; set; }

        [DataMember(Name = "length", EmitDefaultValue = false)]
        public double? LengthMm { get; set; }

        [DataMember(Name = "width", EmitDefaultValue = false)]
        public double? WidthMm { get; set; }

        [DataMember(Name = "height", EmitDefaultValue = false)]
        public double? HeightMm { get; set; }

        [DataMember(Name = "diameter", EmitDefaultValue = false)]
        public double? DiameterMm { get; set; }
    }
}
